window.top!=self&&(window.top.location=self.location);var $url="/index",$idSite="site",$sidebarWidth=200,$collapseWidth=60,data=utils.init({siteId:utils.getQueryInt("siteId"),sessionId:localStorage.getItem("sessionId"),version:null,adminLogoUrl:null,adminTitle:null,isSuperAdmin:null,culture:null,plugins:null,menus:[],siteType:null,siteUrl:null,previewUrl:null,local:null,menu:null,keyword:null,newCms:null,newPlugins:[],defaultOpeneds:[],defaultActive:null,tabName:null,tabs:[],winHeight:0,winWidth:0,isCollapse:!1,isDesktop:!0,isMobileMenu:!1,contextMenuVisible:!1,contextTabName:null,contextLeft:0,contextTop:0}),methods={apiGet:function(){var e=this;$api.get($url,{params:{siteId:this.siteId,sessionId:this.sessionId}}).then(function(t){var i=t.data;if(i.value){utils.addTab("首页",utils.getRootUrl("dashboard")),e.version=i.version,e.adminLogoUrl=i.adminLogoUrl||utils.getAssetsUrl("images/logo.png"),e.adminTitle=i.adminTitle||"SS CMS",e.isSuperAdmin=i.isSuperAdmin,e.culture=i.culture,e.plugins=i.plugins,e.menus=i.menus,e.siteType=i.siteType,e.siteUrl=i.siteUrl,e.previewUrl=i.previewUrl,e.local=i.local;var n=[];if(location.hash){var s=location.hash.substr(1).split("/"),l=s[0];e.menu=_.find(e.menus,function(e){return e.id==l});for(var o=1;o<s.length&&s[o];o++)n.push(s[o])}!e.menu&&e.menus.length>0&&(e.menu=e.menus[0]),e.btnTopMenuClick(e.menu),n.length>0&&e.btnSideMenuClick(n.join("/")),document.title=e.adminTitle,setTimeout(e.ready,100)}else location.href=i.redirectUrl}).catch(function(e){e.response&&400===e.response.status?utils.error(e,{redirect:!0}):!e.response||401!==e.response.status&&403!==e.response.status?e.response&&500===e.response.status&&utils.error(e):location.href=utils.getRootUrl("login")})},apiCache:function(){0!==this.siteId&&$api.post($url+"/actions/cache",{siteId:this.siteId}).then(function(e){e.data}).catch(function(e){utils.error(e)})},ready:function(){window.onresize=this.winResize,window.onresize(),this.apiCache(),this.isSuperAdmin&&this.getUpdates(),utils.loading(this,!1)},getUpdates:function(){var e=this,t=this.plugins.map(function(e){return e.pluginId});cloud.getUpdates(e.version,t).then(function(t){var i=t.data,n=i.cms,s=i.plugins;n&&-1===cloud.compareVersion(e.version,n.version)&&(e.newCms={current:e.version,version:n.version,published:n.published});for(var l=0;l<s.length;l++){var o=s[l];if(o&&o.version){var u=$.grep(e.plugins,function(e){return e.pluginId==o.pluginId});if(1==u.length){var r=u[0];r.version?-1==cloud.compareVersion(r.version,o.version)&&e.newPlugins.push({pluginId:o.pluginId,displayName:r.displayName,current:r.version,version:o.version,published:o.published}):e.newPlugins.push({pluginId:o.pluginId,displayName:r.displayName,current:"0.0",version:o.version,published:o.published})}}}})},openContextMenu:function(e){e.srcElement.id&&_.startsWith(e.srcElement.id,"tab-")&&(this.contextTabName=_.trimStart(e.srcElement.id,"tab-"),this.contextMenuVisible=!0,this.contextLeft=e.clientX,e.clientX+130>this.winWidth?this.contextLeft=this.winWidth-130:this.contextLeft=e.clientX,this.contextTop=e.clientY)},closeContextMenu:function(){this.contextMenuVisible=!1},btnContextClick:function(e){var t=this;if("this"===e)this.tabs=this.tabs.filter(function(e){return e.name!==t.contextTabName});else if("others"===e)this.tabs=this.tabs.filter(function(e){return e.name===t.contextTabName}),utils.openTab(t.contextTabName);else if("left"===e){var i=!1;this.tabs=this.tabs.filter(function(e){return e.name===t.contextTabName&&(i=!0),e.name===t.contextTabName||i})}else if("right"===e){i=!1;this.tabs=this.tabs.filter(function(e){return e.name===t.contextTabName&&(i=!0),e.name===t.contextTabName||!i})}else"all"===e&&(this.tabs=[]);this.closeContextMenu()},winResize:function(){this.winHeight=$(window).height(),this.winWidth=$(window).width(),this.isDesktop=this.winWidth>992},getIndex:function(e,t,i){return i?e.id+"/"+t.id+"/"+i.id:t?e.id+"/"+t.id:e?e.id:""},btnSearchClick:function(){this.keyword&&utils.addTab("内容搜索",utils.getCmsUrl("contentsSearch",{siteId:this.siteId,keyword:this.keyword}))},btnTopMenuClick:function(e){if(e){if(e.children&&e.children.length>0){var t=e.children[0];t.children&&(this.defaultOpeneds=[t.id])}else this.btnMenuClick(e);this.menu=e}},btnSideMenuClick:function(e){for(var t=e.split("/"),i=this.menu.children,n=null,s=[],l=0;l<t.length;l++)(n=_.find(i,function(e){return e.id==t[l]}))&&(i=n.children,s.push(n.id));this.defaultOpeneds=s,n&&this.btnMenuClick(n),location.hash=this.menu.id+"/"+e},btnMenuClick:function(e){this.defaultActive=this.defaultOpeneds.join("/"),this.isMobileMenu=!1,"_layer"==e.target?utils.openLayer({title:e.text,url:e.link,full:!0}):"_self"==e.target?location.href=e.link:"_parent"==e.target?parent.location.href=e.link:"_top"==e.target?top.location.href=e.link:"_blank"==e.target?window.open(e.link):utils.addTab(e.text,e.link)},btnMobileMenuClick:function(){this.isCollapse=!1,this.isMobileMenu=!this.isMobileMenu},btnUserMenuClick:function(e){"view"===e?utils.openLayer({title:"查看资料",url:utils.getSettingsUrl("administratorsLayerView",{pageType:"user",userId:this.local.userId}),full:!0}):"profile"===e?utils.openLayer({title:"修改资料",url:utils.getSettingsUrl("administratorsLayerProfile",{pageType:"user",userId:this.local.userId}),full:!0}):"password"===e?utils.openLayer({title:"更改密码",url:utils.getSettingsUrl("administratorsLayerPassword",{pageType:"user",userId:this.local.userId}),full:!0}):"logout"===e&&(location.href=utils.getRootUrl("logout"))},btnCultureClick:function(e){$api.post($url+"/actions/setLanguage",{culture:e}).then(function(e){e.data;location.reload()}).catch(function(e){utils.error(e)})}},$vue=new Vue({el:"#main",data:data,methods:methods,created:function(){this.apiGet()},computed:{leftWidth:function(){return this.isDesktop?this.isCollapse?$collapseWidth:$sidebarWidth:this.isMobileMenu?this.winWidth:0}},watch:{contextMenuVisible(e){this.contextMenuVisible?document.body.addEventListener("click",this.closeContextMenu):document.body.removeEventListener("click",this.closeContextMenu)}}});