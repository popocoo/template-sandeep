var $url="/settings/administratorsRoleAdd",data=utils.init({roleId:utils.getQueryInt("roleId"),pageType:null,form:{roleName:null,description:null,checkedPermissions:null},permissions:null,allPermissions:null,systemCheckAll:!1,isSystemIndeterminate:!0,sites:null,checkedSiteIds:null,site:null,permissionInfo:null,treeData:[],defaultExpandedKeys:[]}),methods={getConfig:function(){var s=this;utils.loading(this,!0),$api.get($url,{params:{roleId:this.roleId}}).then(function(e){var i=e.data;i.role&&(s.form.roleName=i.role.roleName,s.form.description=i.role.description),s.permissions=i.permissions,s.form.checkedPermissions=[],s.allPermissions=[];for(var n=0;n<i.permissions.length;n++)s.allPermissions.push(i.permissions[n].name),i.permissions[n].selected&&s.form.checkedPermissions.push(i.permissions[n].name);s.sites=i.sites,s.checkedSiteIds=i.checkedSiteIds||[];for(n=0;n<i.sitePermissionsList.length;n++)for(var t=s.getPermissionInfo(i.sitePermissionsList[n]),o=0;o<i.sites.length;o++){var r=i.sites[o];r.id===t.siteId&&(r.permissionInfo=t)}s.pageType="role"}).catch(function(s){utils.error(s)}).then(function(){utils.loading(s,!1)})},handleSystemCheckAllChange:function(s){if(this.form.checkedPermissions=[],s)for(var e=0;e<this.permissions.length;e++)this.form.checkedPermissions.push(this.permissions[e].name);this.isSystemIndeterminate=!1},handleCheckedPermissionsChange:function(s){var e=s.length;this.systemCheckAll=e===this.permissions.length,this.isSystemIndeterminate=e>0&&e<this.permissions.length},getPermissionText:function(s){for(var e=0;e<this.permissions.length;e++)if(this.permissions[e].name===s)return this.permissions[e].text;return""},getPermissionInfo:function(s){for(var e=s.sitePermissions||[],i=[],n=[],t=0;t<e.length;t++)n.push(e[t].name),e[t].selected&&i.push(e[t].name);var o=s.channelPermissions||[],r=[],h=[];for(t=0;t<o.length;t++)h.push(o[t].name),o[t].selected&&r.push(o[t].name);var m=s.contentPermissions||[],l=[],a=[];for(t=0;t<m.length;t++)a.push(m[t].name),m[t].selected&&l.push(m[t].name);var c=s.channel,f=s.checkedChannelIds||[];return{siteId:s.value,sitePermissions:e,siteCheckAll:!1,isSiteIndeterminate:!0,allSitePermissions:n,checkedSitePermissions:i,channelPermissions:o,channelCheckAll:!1,isChannelIndeterminate:!0,allChannelPermissions:h,checkedChannelPermissions:r,contentPermissions:m,contentCheckAll:!1,isContentIndeterminate:!0,allContentPermissions:a,checkedContentPermissions:l,channel:c,checkedChannelIds:f}},btnPermissionClick:function(s){if(this.site=s,this.site.permissionInfo)return this.permissionInfo=this.site.permissionInfo,void(this.pageType="permissions");var e=this;utils.loading(this,!0),$api.get($url+"/"+this.site.id,{params:{roleId:this.roleId}}).then(function(s){var i=s.data;e.site.permissionInfo=e.getPermissionInfo(i),e.permissionInfo=e.site.permissionInfo,e.treeData=[e.permissionInfo.channel],e.defaultExpandedKeys=[e.permissionInfo.channel.id],e.pageType="permissions"}).catch(function(s){utils.error(s)}).then(function(){utils.loading(e,!1)})},handleSiteCheckAllChange:function(s){if(this.permissionInfo.checkedSitePermissions=[],s)for(var e=0;e<this.permissionInfo.sitePermissions.length;e++)this.permissionInfo.checkedSitePermissions.push(this.permissionInfo.sitePermissions[e].name);this.permissionInfo.isSiteIndeterminate=!1},handleCheckedSitePermissionsChange:function(s){var e=s.length;this.permissionInfo.siteCheckAll=e===this.permissionInfo.sitePermissions.length,this.permissionInfo.isSiteIndeterminate=e>0&&e<this.permissionInfo.sitePermissions.length},getSitePermissionText:function(s){for(var e=0;e<this.permissionInfo.sitePermissions.length;e++)if(this.permissionInfo.sitePermissions[e].name===s)return this.permissionInfo.sitePermissions[e].text;return""},handleChannelCheckAllChange:function(s){if(this.permissionInfo.checkedChannelPermissions=[],s)for(var e=0;e<this.permissionInfo.channelPermissions.length;e++)this.permissionInfo.checkedChannelPermissions.push(this.permissionInfo.channelPermissions[e].name);this.permissionInfo.isChannelIndeterminate=!1},handleContentCheckAllChange:function(s){if(this.permissionInfo.checkedContentPermissions=[],s)for(var e=0;e<this.permissionInfo.contentPermissions.length;e++)this.permissionInfo.checkedContentPermissions.push(this.permissionInfo.contentPermissions[e].name);this.permissionInfo.isContentIndeterminate=!1},handleTreeChanged:function(){this.permissionInfo.checkedChannelIds=this.$refs.tree.getCheckedKeys()},handleCheckedChannelPermissionsChange:function(s){var e=s.length;this.permissionInfo.channelCheckAll=e===this.permissionInfo.channelPermissions.length,this.permissionInfo.isChannelIndeterminate=e>0&&e<this.permissionInfo.channelPermissions.length},handleCheckedContentPermissionsChange:function(s){var e=s.length;this.permissionInfo.contentCheckAll=e===this.permissionInfo.contentPermissions.length,this.permissionInfo.isContentIndeterminate=e>0&&e<this.permissionInfo.contentPermissions.length},getChannelPermissionText:function(s){for(var e=0;e<this.permissionInfo.channelPermissions.length;e++)if(this.permissionInfo.channelPermissions[e].name===s)return this.permissionInfo.channelPermissions[e].text;return""},getContentPermissionText:function(s){for(var e=0;e<this.permissionInfo.contentPermissions.length;e++)if(this.permissionInfo.contentPermissions[e].name===s)return this.permissionInfo.contentPermissions[e].text;return""},apiSubmit:function(){var s=this;utils.loading(this,!0);for(var e=[],i=0;i<this.sites.length;i++){var n=this.sites[i];n.permissionInfo&&e.push({siteId:n.id,channelIds:n.permissionInfo.checkedChannelIds,channelPermissions:n.permissionInfo.checkedChannelPermissions,contentPermissions:n.permissionInfo.checkedContentPermissions,permissions:_.union(n.permissionInfo.checkedSitePermissions)})}this.roleId>0?(utils.loading(this,!0),$api.put($url+"/"+this.roleId,{roleName:this.form.roleName,description:this.form.description,appPermissions:this.form.checkedPermissions,sitePermissions:e}).then(function(s){s.data;setTimeout(function(){utils.removeTab()},1e3),utils.success("角色保存成功！")}).catch(function(s){utils.error(s)}).then(function(){utils.loading(s,!1)})):(utils.loading(this,!0),$api.post($url,{roleName:this.form.roleName,description:this.form.description,appPermissions:this.form.checkedPermissions,sitePermissions:e}).then(function(s){s.data;setTimeout(function(){utils.removeTab()},1e3),utils.success("角色保存成功！")}).catch(function(s){utils.error(s)}).then(function(){utils.loading(s,!1)}))},btnSaveClick:function(){var s=this;this.$refs.form.validate(function(e){e&&s.apiSubmit()})},btnCloseClick:function(){utils.removeTab()},btnSubmitClick:function(){-1===this.checkedSiteIds.indexOf(this.site.id)&&this.checkedSiteIds.push(this.site.id),this.pageType="role"},btnCancelClick:function(){this.pageType="role"}},$vue=new Vue({el:"#main",data:data,methods:methods,created:function(){this.getConfig()}});