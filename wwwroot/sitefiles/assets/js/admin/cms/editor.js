var $url="/cms/editor/editor",data=utils.init({siteId:utils.getQueryInt("siteId"),channelId:utils.getQueryInt("channelId"),contentId:utils.getQueryInt("contentId"),page:utils.getQueryInt("page"),tabName:utils.getQueryString("tabName"),mainHeight:"",isSettings:!0,sideType:"first",collapseSettings:["checkedLevel","addDate"],collapseMore:["translates"],site:null,siteUrl:null,channel:null,groupNames:null,tagNames:null,checkedLevels:null,siteOptions:null,channelOptions:null,styles:null,form:null,translates:[],isPreviewSaving:!1}),methods={runFormLayerImageUploadText:function(t,e,i){this.insertText(t,e,i)},runFormLayerImageUploadEditor:function(t,e){this.insertEditor(t,e)},runMaterialLayerImageSelect:function(t,e,i){this.insertText(t,e,i)},runFormLayerFileUpload:function(t,e,i){this.insertText(t,e,i)},runMaterialLayerFileSelect:function(t,e,i){this.insertText(t,e,i)},runFormLayerVideoUpload:function(t,e,i){this.insertText(t,e,i)},runMaterialLayerVideoSelect:function(t,e,i){this.insertText(t,e,i)},runEditorLayerImage:function(t,e){this.insertEditor(t,e)},insertText:function(t,e,i){var n=this.form[utils.getCountName(t)];n&&n<e&&(this.form[utils.getCountName(t)]=e),this.form[utils.getExtendName(t,e)]=i,this.form=_.assign({},this.form)},insertEditor:function(t,e){t||(t="Body"),e&&UE.getEditor(t,{allowDivTransToP:!1,maximumWords:99999999}).execCommand("insertHTML",e)},addTranslation:function(t,e,i,n){this.translates.push({siteId:this.siteId,channelId:this.channelId,targetSiteId:t,targetChannelId:e,translateType:i,summary:n})},updateGroups:function(t,e){this.groupNames=t.groupNames,utils.success(e)},apiGet:function(){var t=this;window.onresize=function(){t.mainHeight=$(window).height()-70+"px"},window.onresize(),$api.get($url,{params:{siteId:t.siteId,channelId:t.channelId,contentId:t.contentId}}).then(function(e){var i=e.data;t.site=i.site,t.siteUrl=i.siteUrl,t.channel=i.channel,t.groupNames=i.groupNames,t.tagNames=i.tagNames,t.checkedLevels=i.checkedLevels,t.siteOptions=i.siteOptions,t.channelOptions=i.channelOptions,t.styles=i.styles,t.form=_.assign({},i.content),t.form.checked&&(t.form.checkedLevel=t.site.checkContentLevel),-1===t.checkedLevels.indexOf(t.form.checkedLevel)&&(t.form.checkedLevel=i.checkedLevel),(t.form.top||t.form.recommend||t.form.hot||t.form.color)&&t.collapseSettings.push("attributes"),t.form.groupNames&&t.form.groupNames.length>0?t.collapseSettings.push("groupNames"):t.form.groupNames=[],t.form.tagNames&&t.form.tagNames.length>0?t.collapseSettings.push("tagNames"):t.form.tagNames=[],t.form.linkUrl&&t.collapseSettings.push("linkUrl");for(var n=0;n<t.styles.length;n++){var s=t.styles[n];"Image"!==s.inputType&&"File"!==s.inputType&&"Video"!==s.inputType||(t.form[utils.getCountName(s.attributeName)]=utils.toInt(t.form[utils.getCountName(s.attributeName)]))}setTimeout(function(){for(var e=0;e<t.styles.length;e++){var i=t.styles[e];if("TextEditor"===i.inputType){var n=UE.getEditor(i.attributeName,{allowDivTransToP:!1,maximumWords:99999999});n.styleIndex=e,n.ready(function(){n.addListener("contentChange",function(){var e=t.styles[this.styleIndex];t.form[_.lowerFirst(e.attributeName)]=this.getContent()})})}}},100)}).catch(function(t){utils.error(t)}).then(function(){utils.loading(t,!1)})},apiInsert:function(){var t=this;utils.loading(this,!0),$api.post($url,{siteId:this.siteId,channelId:this.channelId,contentId:this.contentId,content:this.form,translates:this.translates}).then(function(e){e.data;t.closeAndRedirect()}).catch(function(t){utils.error(t)}).then(function(){utils.loading(t,!1)})},apiPreview:function(){var t=this;utils.loading(this,!0),$api.post($url+"/actions/preview",{siteId:this.siteId,channelId:this.channelId,contentId:this.contentId,content:this.form}).then(function(e){var i=e.data;t.isPreviewSaving=!1,window.open(i.url)}).catch(function(t){utils.error(t)}).then(function(){utils.loading(t,!1)})},apiUpdate:function(){var t=this;utils.loading(this,!0),$api.put($url,{siteId:this.siteId,channelId:this.channelId,contentId:this.contentId,content:this.form,translates:this.translates}).then(function(e){e.data;t.closeAndRedirect()}).catch(function(t){utils.error(t)}).then(function(){utils.loading(t,!1)})},closeAndRedirect:function(t){var e=utils.getTabVue(this.tabName);e&&(t?e.apiList(this.channelId,this.page,"内容保存成功！"):e.apiList(this.channelId,this.page,"内容保存成功！",!0)),utils.removeTab(),utils.openTab(this.tabName)},btnLayerClick:function(t){var e={siteId:this.siteId,channelId:this.channelId,editorAttributeName:"Body"};t.contentId&&(e.contentId=t.contentId),t.attributeName&&(e.attributeName=t.attributeName),t.no&&(e.no=t.no);var i={title:t.title,url:utils.getCommonUrl(t.name,e)};t.full||(i.width=t.width?t.width:700,i.height=t.height?t.height:500),utils.openLayer(i)},handleTranslationClose:function(t){this.translates=_.remove(this.translates,function(e){return t!==e.summary})},btnSaveClick:function(){var t=this;UE&&$.each(UE.instants,function(t,e){e.sync()}),this.$refs.form.validate(function(e){e?0===t.contentId?t.apiInsert():t.apiUpdate():utils.error("保存失败，请检查表单值是否正确")})},btnPreviewClick:function(){var t=this;this.isPreviewSaving||(UE&&$.each(UE.instants,function(t,e){e.sync()}),this.$refs.form.validate(function(e){e?t.apiPreview():utils.error("预览失败，请检查表单值是否正确")}))},btnCloseClick:function(){utils.removeTab()},btnGroupAddClick:function(){utils.openLayer({title:"新增内容组",url:utils.getCommonUrl("groupContentLayerAdd",{siteId:this.siteId}),width:500,height:300})},btnTranslateAddClick:function(){utils.openLayer({title:"选择转移栏目",url:utils.getCmsUrl("editorLayerTranslate",{siteId:this.siteId,channelId:this.channelId}),width:620,height:400})},btnExtendAddClick:function(t){var e=this.form[utils.getCountName(t.attributeName)]+1;this.form[utils.getCountName(t.attributeName)]=e,this.form[utils.getExtendName(t.attributeName,e)]="",this.form=_.assign({},this.form)},btnExtendRemoveClick:function(t){var e=this.form[utils.getCountName(t.attributeName)];this.form[utils.getCountName(t.attributeName)]=e-1,this.form[utils.getExtendName(t.attributeName,e)]="",this.form=_.assign({},this.form)},btnExtendPreviewClick:function(t,e){for(var i=this.form[utils.getCountName(t)],n=[],s=0;s<=i;s++){var a=this.form[utils.getExtendName(t,s)];a=utils.getUrl(this.siteUrl,a),n.push({src:a})}layer.photos({photos:{start:e,data:n},anim:5})}},$vue=new Vue({el:"#main",data:data,methods:methods,created:function(){this.apiGet()}});