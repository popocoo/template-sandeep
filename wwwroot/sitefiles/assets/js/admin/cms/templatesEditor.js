var $url="/cms/templates/templatesEditor",$urlSettings=$url+"/actions/settings",$urlPreview=$url+"/actions/preview",$urlGetContents=$url+"/actions/getContents",validateRelatedFileName=function(t,e,n){""===e||"T_"===e?n(new Error("请输入模板文件")):n()},data=utils.init({siteId:utils.getQueryInt("siteId"),templateId:utils.getQueryInt("templateId"),templateType:utils.getQueryString("templateType"),createdFileFullNameTips:"以“~/”开头代表系统根目录，以“@/”开头代表站点根目录",channels:null,contents:null,content:null,contentEditor:null,createdFileExtNames:[".html",".htm",".shtml",".xml",".json",".js"],panelSettings:!1,settings:null,panelDataSource:!1,dataSource:{channelIds:[],channelId:0,contentId:null},next:"",editorHeight:0,isMore:!1,isPreview:!1}),methods={apiGet:function(){var t=this;utils.loading(this,!0),$api.get($url,{params:{siteId:this.siteId,templateType:this.templateType,templateId:this.templateId}}).then(function(e){var n=e.data;t.settings=n.settings,t.content=n.content,t.channels=n.channels,t.dataSource.channelIds=n.channelIds,t.dataSource.channelId=n.channelId,t.contents=n.contents,t.dataSource.contentId=0===n.contentId?null:n.contentId,t.setEditorContent(t.content),window.addEventListener("beforeunload",function(e){var n=t.getEditorContent();t.content==n?delete e.returnValue:(e.preventDefault(),e.returnValue="")})}).catch(function(t){utils.error(t)}).then(function(){utils.loading(t,!1)})},apiSubmit:function(t){this.content=this.getEditorContent();var e=this;utils.loading(this,!0),$api.post($url,{siteId:this.siteId,templateId:this.settings.templateId,content:this.content}).then(function(e){e.data;utils.success("模板代码保存成功!"),t&&setTimeout(function(){window.close()},1e3)}).catch(function(t){utils.error(t)}).then(function(){utils.loading(e,!1)})},apiSettings:function(){var t=this;utils.loading(this,!0),$api.post($urlSettings,this.settings).then(function(e){var n=e.data;t.panelSettings=!1,t.settings=n.settings,"submit"==t.next?t.apiSubmit(!1):"submitAndClose"==t.next?t.apiSubmit(!0):"preview"==t.next?t.apiPreview():utils.success("模板设置保存成功!")}).catch(function(t){utils.error(t)}).then(function(){utils.loading(t,!1)})},apiPreview:function(){this.content=this.getEditorContent();var t=this;utils.loading(this,!0),$api.post($urlPreview,{siteId:this.siteId,channelId:this.dataSource.channelId||0,contentId:this.dataSource.contentId||0,templateId:this.settings.templateId||0,content:this.content}).then(function(e){var n=e.data,i=n.baseUrl,a=n.html,s=document.getElementById("preview");s.children.length>0&&s.removeChild(s.firstChild);var o=document.createElement("iframe");o.style.width="100%",o.style.height="100%",o.style.border="0",s.appendChild(o);var l=o.contentDocument||o.contentWindow.document;value=a.replace("<head>","<head><base href='"+i+"' /><script>if ( window.innerWidth === 0 ) { window.innerWidth = parent.innerWidth; window.innerHeight = parent.innerHeight; }<\/script>"),l.open(),l.write(value),l.close(),t.isPreview=!0}).catch(function(t){utils.error(t)}).then(function(){utils.loading(t,!1)})},apiGetContents:function(){var t=this;$api.post($urlGetContents,{siteId:this.siteId,channelId:this.dataSource.channelId}).then(function(e){var n=e.data;t.contents=n.contents,t.dataSource.contentId=0===n.contentId?null:n.contentId}).catch(function(t){utils.error(t)}).then(function(){utils.loading(t,!1)})},getTemplateType:function(){return"IndexPageTemplate"===this.templateType?"首页模板":"ChannelTemplate"===this.templateType?"栏目模板":"ContentTemplate"===this.templateType?"内容模板":"FileTemplate"===this.templateType?"单页模板":""},handleDataSourceChannelChange:function(){this.dataSource.channelId=this.dataSource.channelIds[this.dataSource.channelIds.length-1],this.dataSource.contentId=null,"ContentTemplate"===this.templateType&&this.apiGetContents()},isCreatedFileFullName:function(){return"IndexPageTemplate"===this.templateType||"FileTemplate"===this.templateType},getEditorContent:function(){return this.contentEditor.getModel().getValue()},setEditorContent:function(t){var e=this;this.contentEditor?(this.contentEditor.getModel().setValue(t),this.contentEditor.focus()):setTimeout(function(){require.config({paths:{vs:utils.getAssetsUrl("lib/monaco-editor/min/vs")}}),require(["vs/editor/editor.main"],function(){e.contentEditor=monaco.editor.create(document.getElementById("editor"),{value:t,language:"html"}),e.contentEditor.focus()})},100)},btnMoreClick:function(){this.isMore=!this.isMore},btnCodeClick:function(){this.isPreview=!1},btnFormatClick:function(){this.isMore=!1,this.contentEditor.getAction("editor.action.formatDocument").run().then(function(){utils.success("模板代码格式化成功!")})},btnSettingsClick:function(){this.isMore=!1,this.panelSettings=!0,this.next=""},btnDataSourceClick:function(){this.isMore=!1,this.panelDataSource=!0},btnRestoreClick:function(){this.isMore=!1,utils.openLayer({title:"还原历史版本",url:utils.getCmsUrl("templatesEditorLayerRestore",{siteId:this.siteId,templateId:this.templateId}),full:!0})},btnCreateClick:function(){var t=this;this.isMore=!1,utils.loading(this,!0),$api.post($url+"/actions/create",{siteId:this.siteId,templateId:this.templateId}).then(function(e){e.data;utils.openLayer({title:"生成进度查看",url:utils.getCmsUrl("createStatus",{siteId:t.siteId})})}).catch(function(t){utils.error(t)}).then(function(){utils.loading(t,!1)})},btnPreviewClick:function(){0==this.settings.templateId?(this.panelSettings=!0,this.next="preview"):0===this.dataSource.channelId&&"ChannelTemplate"===this.templateType?(this.panelDataSource=!0,this.next="preview"):0!==this.dataSource.channelId&&this.dataSource.contentId&&0!==this.dataSource.contentId||"ContentTemplate"!==this.templateType?this.apiPreview():(this.panelDataSource=!0,this.next="preview")},btnSubmitClick:function(t){0==this.settings.templateId?(this.panelSettings=!0,this.next=t?"submitAndClose":"submit"):this.apiSubmit(t)},btnSettingsSubmitClick:function(){var t=this;this.$refs.settings.validate(function(e){e&&t.apiSettings()})},btnSettingsCancelClick:function(){this.panelSettings=!1},btnDataSourceSubmitClick:function(){var t=this;this.$refs.dataSource.validate(function(e){e&&(t.panelDataSource=!1,t.dataSource.channelId=t.dataSource.channelIds[t.dataSource.channelIds.length-1],"preview"===t.next&&t.apiPreview())})},btnDataSourceCancelClick:function(){this.panelDataSource=!1}},$vue=new Vue({el:"#main",data:data,methods:methods,created:function(){this.editorHeight=$(window).height()+"px",this.apiGet()}});