var $url="/cms/templates/templatesMatch",data=utils.init({siteId:utils.getQueryInt("siteId"),channels:null,channelTemplates:null,contentTemplates:null,expandedChannelIds:[],filterText:"",filterChannelTemplateId:utils.getQueryInt("channelTemplateId"),filterContentTemplateId:utils.getQueryInt("contentTemplateId"),defaultChannelTemplate:null,defaultContentTemplate:null,channelIds:[],channelTemplateId:0,contentTemplateId:0}),methods={apiConfig:function(){var e=this;utils.loading(this,!0),$api.get($url,{params:{siteId:this.siteId}}).then(function(t){var n=t.data;e.channels=[n.channels],e.channelTemplates=n.channelTemplates,e.contentTemplates=n.contentTemplates,e.expandedChannelIds=[e.siteId],e.defaultChannelTemplate=_.find(e.channelTemplates,function(e){return e.defaultTemplate})||{id:0},e.defaultContentTemplate=_.find(e.contentTemplates,function(e){return e.defaultTemplate})||{id:0},e.channelTemplateId=e.defaultChannelTemplate.id,e.contentTemplateId=e.defaultContentTemplate.id,(e.filterChannelTemplateId>0||e.filterContentTemplateId>0)&&setTimeout(function(){e.filter(e.filterText,e.filterChannelTemplateId,e.filterContentTemplateId)},100)}).catch(function(e){utils.error(e)}).then(function(){utils.loading(e,!1)})},apiSubmit:function(e){var t=this;utils.loading(this,!0),$api.post($url,e).then(function(e){var n=e.data;t.channels=[n.value],t.expandedChannelIds=t.channelIds,t.filterText="",t.filterChannelTemplateId=0,t.filterContentTemplateId=0,utils.success("模板匹配成功！")}).catch(function(e){utils.error(e)}).then(function(){utils.loading(t,!1)})},apiCreate:function(e){var t=this;utils.loading(this,!0),$api.post($url+"/actions/create",e).then(function(e){var n=e.data;t.channels=[n.channels],t.channelTemplates=n.channelTemplates,t.contentTemplates=n.contentTemplates,t.expandedChannelIds=t.channelIds,t.filterText="",t.filterChannelTemplateId=0,t.filterContentTemplateId=0,utils.success("模板创建并匹配成功！")}).catch(function(e){utils.error(e)}).then(function(){utils.loading(t,!1)})},getChannelUrl:function(e){return utils.getRootUrl("redirect",{siteId:this.siteId,channelId:e.value})},getChannelTemplateName:function(e){var t=_.find(this.channelTemplates,function(t){return t.id===e});return t?t.templateName:this.defaultChannelTemplate.templateName},getContentTemplateName:function(e){var t=_.find(this.contentTemplates,function(t){return t.id===e});return t?t.templateName:this.defaultContentTemplate.templateName},filterNode:function(e,t){return!e||(e.channelName&&e.channelTemplateId&&e.contentTemplateId?-1!==t.label.indexOf(e.channelName)&&t.channelTemplateId===e.channelTemplateId&&t.contentTemplateId===e.contentTemplateId:e.channelName&&e.channelTemplateId?-1!==t.label.indexOf(e.channelName)&&t.channelTemplateId===e.channelTemplateId:e.channelName&&e.contentTemplateId?-1!==t.label.indexOf(e.channelName)&&t.contentTemplateId===e.contentTemplateId:e.channelTemplateId&&e.contentTemplateId?t.channelTemplateId===e.channelTemplateId&&t.contentTemplateId===e.contentTemplateId:e.channelName?-1!==t.label.indexOf(e.channelName):e.contentTemplateId?t.contentTemplateId===e.contentTemplateId:!e.channelTemplateId||t.channelTemplateId===e.channelTemplateId)},handleCheckChange(){this.channelIds=this.$refs.tree.getCheckedKeys()},btnCreateClick:function(e){var t="",n=null;"CreateChannelTemplate"===e?(t="此操作将创建空的栏目模板并匹配选中栏目, 是否继续?",n={siteId:this.siteId,channelIds:this.channelIds,isChannelTemplate:!0,isChildren:!1}):"CreateSubChannelTemplate"===e?(t="此操作将创建空的栏目模板并匹配选中栏目的下级栏目, 是否继续?",n={siteId:this.siteId,channelIds:this.channelIds,isChannelTemplate:!0,isChildren:!0}):"CreateContentTemplate"===e?(t="此操作将创建空的内容模板并匹配选中栏目, 是否继续?",n={siteId:this.siteId,channelIds:this.channelIds,isChannelTemplate:!1,isChildren:!1}):"CreateSubContentTemplate"===e&&(t="此操作将创建空的内容模板并匹配选中栏目的下级栏目, 是否继续?",n={siteId:this.siteId,channelIds:this.channelIds,isChannelTemplate:!1,isChildren:!0});var l=this;this.$confirm(t,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(function(){l.apiCreate(n)})},btnChannelMatchClick:function(){this.apiSubmit({siteId:this.siteId,channelIds:this.channelIds,isChannelTemplate:!0,templateId:this.channelTemplateId})},btnContentMatchClick:function(){this.apiSubmit({siteId:this.siteId,channelIds:this.channelIds,isChannelTemplate:!1,templateId:this.contentTemplateId})},filter:function(e,t,n){this.$refs.tree.filter({channelName:e,channelTemplateId:t,contentTemplateId:n})}},$vue=new Vue({el:"#main",data:data,methods:methods,watch:{filterText:function(e){this.filter(e,this.filterChannelTemplateId,this.filterContentTemplateId)},filterChannelTemplateId:function(e){this.filter(this.filterText,e,this.filterContentTemplateId)},filterContentTemplateId:function(e){this.filter(this.filterText,this.filterChannelTemplateId,e)}},created:function(){this.apiConfig()}});