var $url="/cms/channels/channels",data=utils.init({siteId:utils.getQueryInt("siteId"),root:null,expandedChannelIds:[],indexNames:[],groupNames:[],channelTemplates:[],contentTemplates:[],defaultChannelTemplate:null,defaultContentTemplate:null,columns:null,commandsWidth:160,channelIds:[],filterText:"",filterIndexName:"",filterGroupName:"",appendPanel:!1,appendForm:null,editPanel:!1,form:null,editLinkTypes:[],editTaxisTypes:[],editEditor:null,styles:[],siteUrl:null,isTemplateEditable:!1,deletePanel:!1,deleteForm:null,importPanel:!1,importForm:null,importUploadList:[]}),methods={runFormLayerImageUploadText:function(t,e,i){this.insertText(t,e,i)},runFormLayerImageUploadEditor:function(t,e){this.insertEditor(t,e)},runMaterialLayerImageSelect:function(t,e,i){this.insertText(t,e,i)},runFormLayerFileUpload:function(t,e,i){this.insertText(t,e,i)},runMaterialLayerFileSelect:function(t,e,i){this.insertText(t,e,i)},runFormLayerVideoUpload:function(t,e,i){this.insertText(t,e,i)},runMaterialLayerVideoSelect:function(t,e,i){this.insertText(t,e,i)},runEditorLayerImage:function(t,e){this.insertEditor(t,e)},insertText:function(t,e,i){var n=this.form[utils.getCountName(t)];n&&n<e&&(this.form[utils.getCountName(t)]=e),this.form[utils.getExtendName(t,e)]=i,this.form=_.assign({},this.form)},insertEditor:function(t,e){t||(t="Body"),e&&UE.getEditor(t,{allowDivTransToP:!1,maximumWords:99999999}).execCommand("insertHTML",e)},setRuleText:function(t,e){e?this.form.channelFilePathRule=t:this.form.contentFilePathRule=t},updateGroups:function(t,e){this.groupNames=t.groupNames,utils.success(e)},apiList:function(t,e){var i=this;utils.loading(this,!0),$api.get($url,{params:{siteId:this.siteId}}).then(function(n){var a=n.data;i.root=[a.channel],i.indexNames=a.indexNames,i.groupNames=a.groupNames,i.channelTemplates=a.channelTemplates,i.contentTemplates=a.contentTemplates,i.defaultChannelTemplate=i.channelTemplates.find(function(t){return t.defaultTemplate}),i.defaultContentTemplate=i.contentTemplates.find(function(t){return t.defaultTemplate}),i.columns=a.columns,i.commandsWidth=a.commandsWidth,i.isTemplateEditable=a.isTemplateEditable,i.expandedChannelIds=e||[i.siteId],i.editLinkTypes=a.linkTypes,i.editTaxisTypes=a.taxisTypes,i.siteUrl=a.siteUrl,t&&utils.success(t)}).catch(function(t){utils.error(t)}).then(function(){utils.loading(i,!1)})},apiGet:function(t){var e=this;utils.loading(this,!0),$api.get($url+"/"+this.siteId+"/"+t).then(function(t){var i=t.data;e.form=_.assign({},i.entity),e.form.groupNames||(e.form.groupNames=[]),e.styles=i.styles,e.form.filePath=i.filePath,e.form.channelFilePathRule=i.channelFilePathRule,e.form.contentFilePathRule=i.contentFilePathRule,e.editPanel=!0,setTimeout(function(){e.loadEditor()},100)}).catch(function(t){utils.error(t)}).then(function(){utils.loading(e,!1)})},apiAppend:function(){var t=this;utils.loading(this,!0),$api.post($url+"/actions/append",{siteId:this.siteId,parentId:this.appendForm.parentIds[this.appendForm.parentIds.length-1],channelTemplateId:this.appendForm.channelTemplateId,contentTemplateId:this.appendForm.contentTemplateId,isParentTemplates:this.appendForm.isParentTemplates,isIndexName:this.appendForm.isIndexName,channels:this.appendForm.channels}).then(function(e){var i=e.data;t.appendPanel=!1,t.apiList("栏目添加成功!",i)}).catch(function(e){utils.loading(t,!1),utils.error(e)})},apiEdit:function(){var t=this;utils.loading(this,!0),$api.put($url,this.form).then(function(e){var i=e.data;t.editPanel=!1,t.apiList("栏目编辑成功!",i)}).catch(function(e){utils.loading(t,!1),utils.error(e)})},apiDelete:function(){var t=this;utils.loading(this,!0),$api.delete($url,{data:this.deleteForm}).then(function(e){var i=e.data;t.deletePanel=!1,t.apiList("栏目删除成功!",i)}).catch(function(e){utils.loading(t,!1),utils.error(e)})},apiImport:function(){var t=this;utils.loading(this,!0),$api.post($url+"/actions/import",{siteId:this.importForm.siteId,channelId:this.importForm.channelIds[this.importForm.channelIds.length-1],fileName:this.importForm.fileName,isOverride:this.importForm.isOverride}).then(function(e){var i=e.data;t.importPanel=!1,t.apiList("栏目导入成功!",i)}).catch(function(e){utils.loading(t,!1),utils.error(e)})},apiDrop:function(t,e,i){var n=this;utils.loading(this,!0),$api.post($url+"/actions/drop",{siteId:this.siteId,sourceId:t,targetId:e,dropType:i}).then(function(t){t.data;utils.success("栏目排序成功!")}).catch(function(t){utils.error(t)}).then(function(){utils.loading(n,!1)})},apiColumns:function(t){$api.post($url+"/actions/columns",{siteId:this.siteId,attributeNames:t}).then(function(t){t.data}).catch(function(t){utils.error(t)})},loadEditor:function(){var t=this;document.getElementById("form_Content1").innerHTML="",document.getElementById("form_Content2").innerHTML="";var e=window.wangEditor;this.editEditor=new e("#form_Content1","#form_Content2"),this.editEditor.customConfig.menus=["head","bold","fontSize","fontName","italic","underline","strikeThrough","foreColor","backColor","link","list","justify","quote","table","undo","redo"],this.editEditor.customConfig.onchange=function(e){t.form.content=e},this.editEditor.create(),this.editEditor.txt.html(this.form.content)},handleColumnsChange:function(){var t=_.filter(this.columns,function(t){return t.isList}),e=_.map(t,function(t){return t.attributeName});this.apiColumns(e)},btnSetClick:function(t,e,i){var n=utils.getCmsUrl("settingsCreateRuleLayerSet",{siteId:this.siteId,isChannel:e,channelId:t,rule:i});utils.openLayer({title:"构造",url:n,width:800,height:500})},getColumnWidth:function(t){return"Id"===t?80:"ChannelTemplateId"===t||"ContentTemplateId"===t?120:"IndexName"===t?120:180},getTemplate:function(t,e){var i=null;return(i=t?this.channelTemplates.find(function(t){return t.id===e}):this.contentTemplates.find(function(t){return t.id===e}))||(i=t?this.defaultChannelTemplate:this.defaultContentTemplate),i},btnTemplateEditClick:function(t,e){if(this.isTemplateEditable){var i=this.getTemplate(t,e);utils.addTab("编辑:"+i.templateName,utils.getCmsUrl("templatesEditor",{siteId:this.siteId,templateId:i.id,templateType:t?"ChannelTemplate":"ContentTemplate"}))}},btnEditAddGroupClick:function(){utils.openLayer({title:"新增栏目组",url:utils.getCommonUrl("groupChannelLayerAdd",{siteId:this.siteId}),width:500,height:300})},handleDrop:function(t,e,i,n){this.apiDrop(t.data.value,e.data.value,i)},allowDrop:function(t,e,i){return e.data.value!==this.siteId},allowDrag:function(t){return t.data.value!==this.siteId},getChannelUrl:function(t){return utils.getRootUrl("redirect",{siteId:this.siteId,channelId:t.value})},handleCheckChange(){this.channelIds=this.$refs.tree.getCheckedKeys()},filterNode:function(t,e){return!t||(t.channelName&&t.indexName&&t.groupName?(-1!==e.label.indexOf(t.channelName)||e.value+""===t.channelName)&&e.channel.indexName===t.indexName&&-1!==e.groupNames.indexOf(t.groupName):t.channelName&&t.indexName?(-1!==e.label.indexOf(t.channelName)||e.value+""===t.channelName)&&e.channel.indexName===t.indexName:t.channelName&&t.groupName?(-1!==e.label.indexOf(t.channelName)||e.value+""===t.channelName)&&-1!==e.groupNames.indexOf(t.groupName):t.indexName&&t.groupName?e.channel.indexName===t.indexName&&-1!==e.groupNames.indexOf(t.groupName):t.channelName?-1!==e.label.indexOf(t.channelName)||e.value+""===t.channelName:t.groupName?-1!==e.groupNames.indexOf(t.groupName):!t.indexName||e.channel.indexName===t.indexName)},btnCancelClick:function(){this.appendPanel=!1,this.deletePanel=!1,this.importPanel=!1,this.editPanel=!1},btnAppendClick:function(){this.appendForm={parentIds:[this.siteId],channelTemplateId:0,contentTemplateId:0,isParentTemplates:!0,isIndexName:!1,channels:""},this.appendPanel=!0},btnAppendSubmitClick:function(){var t=this;this.$refs.appendForm.validate(function(e){e&&t.apiAppend()})},btnEditClick:function(t){this.apiGet(t.value)},btnEditSubmitClick:function(){var t=this;this.$refs.editForm.validate(function(e){e&&t.apiEdit()})},btnDeleteClick:function(t){this.deleteForm={siteId:this.siteId,channelId:t.value,label:t.label,channelName:null,deleteFiles:!1},this.deletePanel=!0},btnDeleteSubmitClick:function(){var t=this;this.$refs.deleteForm.validate(function(e){e&&(t.deleteForm.channelName==t.deleteForm.label?t.apiDelete():utils.error("请检查您输入的栏目名称是否正确"))})},btnImportClick:function(){this.importForm={siteId:this.siteId,channelIds:[this.siteId],fileName:null,isOverride:!0},this.importPanel=!0},btnTranslateClick:function(){location.href=utils.getCmsUrl("channelsTranslate",{siteId:this.siteId,channelIds:this.channelIds.join(","),returnUrl:location.href})},btnImportSubmitClick:function(){var t=this;this.$refs.importForm.validate(function(e){e&&t.apiImport()})},btnExportClick:function(){var t=this;utils.loading(this,!0),$api.post($url+"/actions/export",{siteId:this.siteId,channelIds:this.channelIds}).then(function(t){var e=t.data;window.open(e.value)}).catch(function(t){utils.error(t)}).then(function(){utils.loading(t,!1)})},btnSetGroupClick:function(){utils.openLayer({title:"设置栏目组",url:utils.getCmsUrl("channelsLayerGroup",{siteId:this.siteId,channelIds:this.channelIds.join(",")}),width:700,height:400})},btnSetTaxisClick:function(){utils.openLayer({title:"栏目排序",url:utils.getCmsUrl("channelsLayerTaxis",{siteId:this.siteId,channelIds:this.channelIds.join(",")}),width:500,height:260})},btnCreateClick:function(){utils.openLayer({title:"生成页面",url:utils.getCmsUrl("channelsLayerCreate",{siteId:this.siteId,channelIds:this.channelIds.join(",")}),width:500,height:260})},btnMenuClick:function(t,e){var i=utils.addQuery(t.link,{siteId:this.siteId,channelId:e.value});"_layer"==t.target?utils.openLayer({title:t.text,url:i,full:!0}):"_self"==t.target?location.href=i:"_parent"==t.target?parent.location.href=i:"_top"==t.target?top.location.href=i:"_blank"==t.target?window.open(i):utils.addTab(t.text,i)},uploadBefore(t){var e=-1!==t.name.indexOf(".zip",t.name.length-".zip".length);return e||utils.error("导入文件只能是 Zip 格式!"),e},uploadProgress:function(){utils.loading(this,!0)},uploadSuccess:function(t,e){this.loading&&this.loading.close(),this.importForm.fileName=t.value},uploadError:function(t){this.loading&&this.loading.close();var e=JSON.parse(t.message);utils.error(e.message)},btnLayerClick:function(t){var e={siteId:this.siteId};t.attributeName&&(e.attributeName=t.attributeName),t.contentId&&(e.contentId=t.contentId);var i={title:t.title,url:utils.getCommonUrl(t.name,e)};t.full||(i.width=t.width?t.width:700,i.height=t.height?t.height:500),utils.openLayer(i)},btnExtendAddClick:function(t){var e=this.form[utils.getCountName(t.attributeName)]+1;this.form[utils.getCountName(t.attributeName)]=e,this.form[utils.getExtendName(t.attributeName,e)]="",this.form=_.assign({},this.form)},btnExtendRemoveClick:function(t){var e=this.form[utils.getCountName(t.attributeName)];this.form[utils.getCountName(t.attributeName)]=e-1,this.form[utils.getExtendName(t.attributeName,e)]="",this.form=_.assign({},this.form)},btnExtendPreviewClick:function(t,e){for(var i=this.form[utils.getCountName(t)],n=[],a=0;a<=i;a++){var l=this.form[utils.getExtendName(t,a)];l=utils.getUrl(this.siteUrl,l),n.push({src:l})}layer.photos({photos:{start:e,data:n},anim:5})}},$vue=new Vue({el:"#main",data:data,methods:methods,watch:{filterText:function(t){this.$refs.tree.filter({channelName:t,indexName:this.filterIndexName,groupName:this.filterGroupName})},filterIndexName:function(t){this.$refs.tree.filter({channelName:this.filterText,indexName:t,groupName:this.filterGroupName})},filterGroupName:function(t){this.$refs.tree.filter({channelName:this.filterText,indexName:this.filterIndexName,groupName:t})}},created:function(){this.uploadUrl=$apiUrl+$url+"/actions/upload?siteId="+this.siteId,this.apiList()}});